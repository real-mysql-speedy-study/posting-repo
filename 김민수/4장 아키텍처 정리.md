# MySQL 엔진 아키텍처

![](https://velog.velcdn.com/images/inrir/post/c4830265-e996-4f05-9b8d-0b68a2bd510f/image.png)

- MySQL 서버 주요 구성 요소
1. MySQL 엔진
: 클라이언트로부터 접속 및 쿼리 요청을 처리하는 커넥션 핸들러와 SQL 파서 및 전처리기, 쿼리의 최적화된 실행을 위한 옵티마이저가 중심을 이룬다. 
2. 스토리지 엔진
: 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어오는 부분을 스토리지 엔진이 담당한다.
3. 핸들러 API
: MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어나 할 때는 각 스토리지 엔진에 쓰기 또는 읽기를 요청하게 되며, 이러한 요청을 핸들러(Handler) 요청이라고 하고, 여기서 사용되는 API를 핸들러 API라고 한다.

- MySQL 스레딩 구조
1. 포그라운드 스레드
: 최소한 MySQL 서버에 접속된 클라이언트 수 만큼 존재하며, 주로 각 사용자가 요청한 쿼리를 처리한다. 
2. 백그라운드 스레드
: MyISAM의 경우에는 해당 사항이 없는 부분이지만,  InnoDB는 아래와 같이 여러 작업이 백그라운드로 처리됩니다. 

- 메모리 할당 및 사용 구조
1. 글로벌 메모리 영역
: MySQL 서버가 시작되면서 생성된 영역으로 생성이 되면 모든 스레드에 의해 공유된다.
2. 로컬 메모리 영역
: 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역이며, 대표적으로 커넥션 버퍼와 정렬 버퍼 등이 있다.

- 플러그인 스토리지 엔진 모델
: MySQL은 이미 많은 스토리지 엔진을 가지고 있지만 사용자의 요구사항과 필요에 의해 추가로 다른 형태의 스토리지 엔진이 필요할 수 있다.

- 컴포넌트
: MySQL 8.0 부터는 기존의 플러그인 아키텍처를 대체하기 위해서 컴포넌트 아키텍처가 지원한다. 

- 쿼리 실행 구조
: 쿼리파서 -> 전처리기 -> 옵티마이저 -> 쿼리 실행기 -> 핸들러(스토리지 엔진)

- 복제
: MySQL에서 중요한 역할이지만, 자세한 설명은 16장 참조

- 스레드 풀
: 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여서 동시 처리되는 요청이 많다 하더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것이 목적이다.

- 트랜잭션 지원 메타데이터
: 데이터베이스에서 테이블 구조 정보, 오브젝트 정보 등의 여러 정보를 담아두는 곳을 보통 데이터 딕셔너리 또는 메타데이터라고 합니다.

## InnoDB 스토리지 엔진 아키텍처
![](https://velog.velcdn.com/images/inrir/post/0eb9716b-020f-4d8e-8d2c-e834983668d2/image.png)
- 프라이머리 키에 의한 클러스터링
: InnoDB의 모든 테이블은 기본적으로 PK를 기준으로, PK 값의 순서대로 디스크에 저장된다. 

- 외래 키 지원
: 외래 키 지원은 InnoDB 스토리지 엔진 레벨에서 지원하는 기능으로, MyISAM이나 MEMORY 테이블에서는 사용할 수 없다. 개발에서 좋은 가이드 역할을 해줌과 동시에 데드락 발생 경우와 잠금 등의 주의하여 사용해야 한다.

- MVCC(Multi Version Concurrency Control)
: 잠금을 사용하지 않는 일관된 읽기를 제공하는데 있다. 

- 잠금없는 일관된 읽기(Non-Locking Consistent Read)
: InnoDB 스토리지 엔진은 MVCC 기술로 잠금을 걸지않고 읽기 작업을 수행한다.

- 자동 데드락 감지
: 내부적으로 잠금이 교착 상태에 빠지지 않았는지 체크하기 위해 잠금 대기 목록을 그래프(Wait-for-List) 형태로 관리한다.

- 자동화된 장애 복구
: InnoDB에는 손실이나 장애로부터 데이터를 보호하기 위한 여러 메커니즘이 들어있다.

- InnoDB 버퍼풀
: InnoDB 스토리지 엔진에서 가장 핵심적인 부분으로 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해두는 공간이다. (LRU 리스트, Flush 리스트, Free 리스트)

- Double Write Buffer
: 더티 페이지를 디스크 파일로 플러시할 때 일부만 기록되는 현상을 파셜 페이지 또는 톤 페이지(torn-page)라고 하는데, InnoDB는 이러한 문제를 Double-Write 기법으로 해결한다.

- 언두 로그(undo log)
: InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML 쿼리로 변경되기 이전 버전의 데이터를 별도로 백업하는데 이러한 백업된 데이터를 언두 로그라고 한다.

- 체인지 버퍼
: InnoDB는 변경해야 할 인덱스 페이지가 버퍼 풀에 있으면 바로 업데이트를 수행하지만, 디스크에서 읽어와서 업데이트해야 한다면 이를 즉시 실행시키지 않고 임시 공간에 저장해두고 바로 사용자에게 결과를 반환하는 형태로 성능을 향상시키는데, 이때 사용하는 임시 메모리 공간을 체인지 버퍼라고 한다.

- 리두 로그 및 로그 버퍼
: 리두 로그는 MySQL 서버가 비정상적으로 종료됐을 경우 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전 장치이다.

- 어댑티브 해시 인덱스
: 어댑티브 해시 인덱스는 사용자가 수동으로 생성하는 인덱스가 아니라 InnoDB 스토리지 엔진에서 사용자가 자주 요청하는 데이터에 대해 자동으로 생성하는 인덱스로 사용자는 "innodb_adaptive_has_index 시스템 변수를 이용해서 어댑티브 해시 인덱스를 활성화 혹은 비활성화를 할 수 있다.

## MyISAM 스토리지 엔진 아키텍처
- 키 캐시
: InnoDB의 버퍼 풀과 비슷한 역할을 하며, 인덱스만을 대상으로 작동한다.

- 운영체제의 캐시 및 버퍼
: MyISAM 테이블의 인덱스는 키 캐시를 이용해 디스크를 검색하지 않고도 충분히 빠르게 검색할 수 있다.

- 데이터 파일과 프라이머리 키(인덱스) 구조
: MyISAM 테이블은 PK에 의한 클러스터링 없이 데이터 파일이 힙 공간처럼 활용된다. 

### MySQL 로그 파일
: MySQL 서버에서 서버의 상태를 진단할 수 있는 많은 도구들이 지원되지만 이러한 기능들은 많은 지식을 필요로 하는 경우가 많다. 그러므로 로그 파일을 통해 해당 오류를 쉽게 감지할 수 있다.

#### 참고 
- Real MySQL 8.0 1편
